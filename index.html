<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Peo by Aditya Jha</title>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <style>
        /* * ==============================================
         * CSS VARIABLES FOR THEMEING
         * ==============================================
         */
        :root {
            --bg-color: #f4f7fa;
            --container-bg: #ffffff;
            --text-primary: #1e293b;
            --text-secondary: #475569;
            --text-subtle: #94a3b8;
            --accent-color: #6366f1;
            --accent-color-hover: #4f46e5;
            --accent-text: #ffffff;
            --border-color: #e2e8f0;
            --input-border: #cbd5e1;
            --input-border-focus: var(--accent-color);
            --shadow-color: rgba(99, 102, 241, 0.2);
            --error-color: #ef4444;
            --disabled-bg: #a5b4fc;
            --disabled-cursor: not-allowed;
            --switch-bg: #cbd5e1;
            --switch-thumb-bg: #ffffff;
            --feature-btn-bg: #f1f5f9;
            --feature-btn-text: #475569;
            --feature-btn-hover-bg: #e2e8f0;
            --llm-output-bg: #f8fafc;
        }

        html.dark {
            --bg-color: #111827;
            --container-bg: #1f2937;
            --text-primary: #f9fafb;
            --text-secondary: #9ca3af;
            --text-subtle: #6b7280;
            --border-color: #374151;
            --input-border: #4b5563;
            --shadow-color: rgba(99, 102, 241, 0.1);
            --switch-bg: #4b5563;
            --feature-btn-bg: #374151;
            --feature-btn-text: #d1d5db;
            --feature-btn-hover-bg: #4b5563;
            --llm-output-bg: #111827;
        }

        /* * ==============================================
         * GENERAL STYLES & LAYOUT
         * ==============================================
         */
        *, *::before, *::after { box-sizing: border-box; }
        html { color-scheme: light dark; }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            display: grid;
            place-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 1.5rem;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .container {
            background-color: var(--container-bg);
            padding: 2rem;
            border-radius: 1.5rem;
            box-shadow: 0 10px 30px -10px var(--shadow-color);
            max-width: 550px;
            width: 100%;
            text-align: center;
            border: 1px solid var(--border-color);
            transition: background-color 0.3s ease, border-color 0.3s ease;
            position: relative;
        }

        /* * ==============================================
         * UI ELEMENTS
         * ==============================================
         */
        .app-header { margin-bottom: 2rem; }
        .app-header h1 { font-size: 2.25rem; font-weight: 700; color: var(--text-primary); line-height: 1.2; }
        .app-header p { font-size: 1rem; color: var(--text-secondary); margin-top: 0.25rem; }

        #wordInput {
            width: 100%;
            padding: 0.875rem 1rem;
            margin-bottom: 1.5rem;
            border: 2px solid var(--input-border);
            border-radius: 0.75rem;
            font-size: 1.125rem;
            background-color: transparent;
            color: var(--text-primary);
            outline: none;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        #wordInput:focus {
            border-color: var(--input-border-focus);
            box-shadow: 0 0 0 3px var(--shadow-color);
        }

        .accent-buttons {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }

        .accent-btn {
            background-color: var(--accent-color);
            color: var(--accent-text);
            padding: 0.75rem 1.25rem;
            border: none;
            border-radius: 0.75rem;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 4px 15px -5px var(--shadow-color);
        }
        .accent-btn:hover {
            background-color: var(--accent-color-hover);
            transform: translateY(-2px);
        }
        .accent-btn:disabled {
            background-color: var(--disabled-bg);
            cursor: var(--disabled-cursor);
            transform: none;
            box-shadow: none;
        }

        /* New Gemini Feature Styles */
        .gemini-features {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 0.75rem;
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border-color);
        }
        .feature-btn {
            background-color: var(--feature-btn-bg);
            color: var(--feature-btn-text);
            padding: 0.6rem 1.2rem;
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.2s ease;
        }
        .feature-btn:hover {
            background-color: var(--feature-btn-hover-bg);
            transform: translateY(-2px);
        }
        .feature-btn:disabled {
            background-color: var(--feature-btn-bg);
            color: var(--text-subtle);
            cursor: var(--disabled-cursor);
            transform: none;
        }

        #llm-output {
            text-align: left;
            margin-top: 1.5rem;
            padding: 1.25rem;
            background-color: var(--llm-output-bg);
            border: 1px solid var(--border-color);
            border-radius: 1rem;
            display: none; /* Hidden by default */
        }
        #llm-output h3 {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0 0 0.5rem 0;
        }
        #llm-output p {
            font-size: 1rem;
            color: var(--text-secondary);
            line-height: 1.6;
            margin: 0;
        }
        .llm-loading-spinner {
            font-size: 1.5rem;
            color: var(--accent-color);
        }

        .loading-indicator { display: none; margin-top: 1.25rem; font-size: 1rem; color: var(--text-secondary); }
        .error-message { color: var(--error-color); margin-top: 1rem; font-size: 0.9rem; min-height: 1.25rem; }
        #audioPlayer { width: 100%; margin-top: 1.5rem; }
        #audioPlayer.hidden { display: none; }
        
        /* THEME SWITCHER */
        .theme-switcher { position: absolute; top: 1.5rem; right: 1.5rem; }
        .theme-toggle-label { display: flex; align-items: center; justify-content: center; width: 50px; height: 26px; background-color: var(--switch-bg); border-radius: 50px; cursor: pointer; position: relative; transition: background-color 0.3s ease; }
        .theme-toggle-checkbox { opacity: 0; width: 0; height: 0; position: absolute; }
        .theme-toggle-label .ball { width: 22px; height: 22px; background-color: var(--switch-thumb-bg); border-radius: 50%; position: absolute; left: 2px; transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .theme-toggle-checkbox:checked + .theme-toggle-label .ball { transform: translateX(24px); }
        .theme-toggle-label .fa-sun { color: #f39c12; margin-left: 5px; }
        .theme-toggle-label .fa-moon { color: #f1c40f; margin-right: 5px; }
    </style>
</head>
<body>

    <div class="container">
        <div class="theme-switcher">
            <input type="checkbox" id="theme-toggle" class="theme-toggle-checkbox">
            <label for="theme-toggle" class="theme-toggle-label">
                <i class="fas fa-sun"></i>
                <i class="fas fa-moon"></i>
                <span class="ball"></span>
            </label>
        </div>

        <header class="app-header">
            <h1>Peo by Aditya Jha</h1>
            <p>Your Instant Pronunciation & TTS Assistant</p>
        </header>
        
        <input type="text" id="wordInput" placeholder="Enter a word...">
        
        <div class="accent-buttons" id="accentButtons">
            <button class="accent-btn" data-accent="american" data-voice="Zephyr">American</button>
            <button class="accent-btn" data-accent="british" data-voice="Enceladus">British</button>
            <button class="accent-btn" data-accent="australian" data-voice="Puck">Australian</button>
            <button class="accent-btn" data-accent="indian" data-voice="Alnilam">Indian</button>
        </div>
        
        <div id="loading" class="loading-indicator">
            <i class="fas fa-spinner fa-spin"></i> Loading pronunciation...
        </div>
        <div id="errorMessage" class="error-message"></div>
        
        <audio id="audioPlayer" controls class="hidden"></audio>

        <!-- Gemini Text Features -->
        <div class="gemini-features">
            <button class="feature-btn" id="defineBtn">✨ Define Word</button>
            <button class="feature-btn" id="exampleBtn">✨ Example Sentence</button>
            <button class="feature-btn" id="suggestBtn">✨ Suggest a Word</button>
        </div>

        <div id="llm-output">
            <h3 id="llm-output-title"></h3>
            <p id="llm-output-content"></p>
        </div>
    </div>

    <script>
        // DOM Elements
        const wordInput = document.getElementById('wordInput');
        const accentButtonsContainer = document.getElementById('accentButtons');
        const loadingIndicator = document.getElementById('loading');
        const errorMessage = document.getElementById('errorMessage');
        const audioPlayer = document.getElementById('audioPlayer');
        const themeToggle = document.getElementById('theme-toggle');
        const defineBtn = document.getElementById('defineBtn');
        const exampleBtn = document.getElementById('exampleBtn');
        const suggestBtn = document.getElementById('suggestBtn');
        const llmOutput = document.getElementById('llm-output');
        const llmOutputTitle = document.getElementById('llm-output-title');
        const llmOutputContent = document.getElementById('llm-output-content');

        // --- THEME SWITCHER LOGIC ---
        function applyTheme(theme) {
            if (theme === 'dark') {
                document.documentElement.classList.add('dark');
                themeToggle.checked = true;
            } else {
                document.documentElement.classList.remove('dark');
                themeToggle.checked = false;
            }
            localStorage.setItem('theme', theme);
        }

        themeToggle.addEventListener('change', () => {
            applyTheme(themeToggle.checked ? 'dark' : 'light');
        });

        document.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('theme');
            const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            applyTheme(savedTheme || (systemPrefersDark ? 'dark' : 'light'));
        });

        // --- API & HELPER FUNCTIONS ---
        const API_KEY = "AIzaSyAgH_ouPFBcK9_FRPcYJk4K1PEJ0aDmN-c"; // Canvas will provide this

        function base64ToArrayBuffer(base64) { /* ... (unchanged) ... */ 
            const binaryString = window.atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) { bytes[i] = binaryString.charCodeAt(i); }
            return bytes.buffer;
        }
        function pcmToWav(pcm16, sampleRate) { /* ... (unchanged) ... */ 
            const numChannels = 1, bytesPerSample = 2;
            const blockAlign = numChannels * bytesPerSample;
            const byteRate = sampleRate * blockAlign;
            const dataSize = pcm16.byteLength;
            const buffer = new ArrayBuffer(44 + dataSize);
            const view = new DataView(buffer);
            function writeString(offset, str) { for (let i = 0; i < str.length; i++) { view.setUint8(offset + i, str.charCodeAt(i)); } }
            writeString(0, 'RIFF'); view.setUint32(4, 36 + dataSize, true); writeString(8, 'WAVE');
            writeString(12, 'fmt '); view.setUint32(16, 16, true); view.setUint16(20, 1, true);
            view.setUint16(22, numChannels, true); view.setUint32(24, sampleRate, true);
            view.setUint32(28, byteRate, true); view.setUint16(32, blockAlign, true);
            view.setUint16(34, 16 * numChannels, true); writeString(36, 'data'); view.setUint32(40, dataSize, true);
            const pcmAsUint8 = new Uint8Array(pcm16.buffer); const wavBytes = new Uint8Array(buffer);
            wavBytes.set(pcmAsUint8, 44);
            return new Blob([wavBytes], { type: 'audio/wav' });
        }
        
        function setInputsDisabled(disabled) {
            wordInput.disabled = disabled;
            document.querySelectorAll('.accent-btn, .feature-btn').forEach(button => {
                button.disabled = disabled;
            });
        }
        
        function showLLMOutputLoading(title) {
            llmOutput.style.display = 'block';
            llmOutputTitle.textContent = title;
            llmOutputContent.innerHTML = '<i class="fas fa-spinner fa-spin llm-loading-spinner"></i>';
        }

        // --- CORE API CALLS ---
        
        // Function for Text-to-Speech API
        async function getPronunciation(word, accent, voiceName) {
            errorMessage.textContent = '';
            audioPlayer.classList.add('hidden');
            loadingIndicator.style.display = 'block';
            setInputsDisabled(true);

            const payload = {
                contents: [{ role: "user", parts: [{ text: `Say in a standard ${accent} accent: ${word}` }] }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName } } }
                },
                model: "gemini-2.5-flash-preview-tts"
            };
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${API_KEY}`;

            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) { const errorData = await response.json(); throw new Error(`API error: ${errorData.error.message || response.statusText}`); }
                const result = await response.json();
                const part = result?.candidates?.[0]?.content?.parts?.[0];
                if (part?.inlineData?.data && part.inlineData.mimeType?.startsWith("audio/")) {
                    const rateMatch = part.inlineData.mimeType.match(/rate=(\d+)/);
                    const sampleRate = rateMatch ? parseInt(rateMatch[1], 10) : 16000;
                    const pcm16 = new Int16Array(base64ToArrayBuffer(part.inlineData.data));
                    const audioUrl = URL.createObjectURL(pcmToWav(pcm16, sampleRate));
                    audioPlayer.src = audioUrl;
                    audioPlayer.classList.remove('hidden');
                    audioPlayer.play();
                } else { throw new Error("Invalid or no audio data received."); }
            } catch (error) {
                console.error("Pronunciation Error:", error);
                errorMessage.textContent = `Failed to get pronunciation.`;
            } finally {
                loadingIndicator.style.display = 'none';
                setInputsDisabled(false);
            }
        }

        // Generic function for Text Generation API
        async function callGeminiTextAPI(prompt, outputTitle) {
            errorMessage.textContent = '';
            showLLMOutputLoading(outputTitle);
            setInputsDisabled(true);

            const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`;

            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) { const errorData = await response.json(); throw new Error(`API error: ${errorData.error.message || response.statusText}`); }
                const result = await response.json();
                const text = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                if (text) {
                    return text.trim();
                } else {
                    throw new Error("No text content received from API.");
                }
            } catch (error) {
                console.error("Gemini Text API Error:", error);
                errorMessage.textContent = `Failed to get response. Please try again.`;
                llmOutput.style.display = 'none';
                return null;
            } finally {
                setInputsDisabled(false);
            }
        }

        // --- EVENT LISTENERS ---

        // Pronunciation buttons (Event Delegation)
        accentButtonsContainer.addEventListener('click', (event) => {
            const button = event.target.closest('.accent-btn');
            if (button) {
                const word = wordInput.value.trim();
                if (word) {
                    getPronunciation(word, button.dataset.accent, button.dataset.voice);
                } else {
                    errorMessage.textContent = "Please enter a word first.";
                    wordInput.focus();
                }
            }
        });

        // Define Word button
        defineBtn.addEventListener('click', async () => {
            const word = wordInput.value.trim();
            if (!word) { errorMessage.textContent = "Please enter a word to define."; return; }
            const prompt = `Define the word "${word}" in a simple, clear way.`;
            const definition = await callGeminiTextAPI(prompt, `Definition of "${word}"`);
            if (definition) {
                llmOutputContent.textContent = definition;
            }
        });

        // Example Sentence button
        exampleBtn.addEventListener('click', async () => {
            const word = wordInput.value.trim();
            if (!word) { errorMessage.textContent = "Please enter a word for an example."; return; }
            const prompt = `Use the word "${word}" in a simple, clear example sentence.`;
            const example = await callGeminiTextAPI(prompt, `Example for "${word}"`);
            if (example) {
                llmOutputContent.textContent = example;
            }
        });

        // Suggest a Word button
        suggestBtn.addEventListener('click', async () => {
            const prompt = `Suggest an interesting but useful English word. Respond ONLY with a valid JSON object with three keys: "word", "definition", and "example".`;
            const responseText = await callGeminiTextAPI(prompt, "Suggesting a Word...");
            if (responseText) {
                try {
                    // Clean the response to ensure it's valid JSON
                    const jsonString = responseText.match(/\{.*\}/s)[0];
                    const data = JSON.parse(jsonString);
                    if (data.word && data.definition && data.example) {
                        wordInput.value = data.word;
                        llmOutputTitle.textContent = `Suggested Word: ${data.word}`;
                        llmOutputContent.innerHTML = `<strong>Definition:</strong> ${data.definition}<br><br><strong>Example:</strong> ${data.example}`;
                    } else {
                        throw new Error("Invalid JSON structure from API.");
                    }
                } catch (e) {
                    console.error("JSON parsing error:", e);
                    errorMessage.textContent = "Could not get a suggestion. Let's try again.";
                    llmOutput.style.display = 'none';
                }
            }
        });

        // Trigger default pronunciation on Enter key
        wordInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                document.querySelector('.accent-btn').click();
            }
        });
    </script>
</body>
</html>
